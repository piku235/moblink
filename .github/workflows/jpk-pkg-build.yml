name: Jpk Package Build (mips-24kec)

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      OPENWRT_VERSION: "24.10.3"
      GCC_VERSION: "13.3.0"
      MAIN_TARGET: "ramips"
      SUB_TARGET: "mt76x8"
      ARCH: "mipsel_24kc"

    steps:
      - uses: actions/checkout@v5

      - name: Common strings
        id: strings
        shell: bash
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          echo "version=${VERSION#v}" >> "$GITHUB_OUTPUT"

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y git gcc g++ pkg-config cmake libssl-dev libdbus-1-dev libglib2.0-dev libavahi-client-dev ninja-build python3-venv python3-dev python3-pip unzip libgirepository1.0-dev libcairo2-dev libreadline-dev default-jre

      - name: Download OpenWRT toolchain
        run: |
          wget -q https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/${MAIN_TARGET}/${SUB_TARGET}/openwrt-toolchain-${OPENWRT_VERSION}-${MAIN_TARGET}-${SUB_TARGET}_gcc-${GCC_VERSION}_musl.Linux-x86_64.tar.zst
          tar -xf openwrt-toolchain-${OPENWRT_VERSION}-${MAIN_TARGET}-${SUB_TARGET}_gcc-${GCC_VERSION}_musl.Linux-x86_64.tar.zst
          mv openwrt-toolchain-${OPENWRT_VERSION}-${MAIN_TARGET}-${SUB_TARGET}_gcc-${GCC_VERSION}_musl.Linux-x86_64 openwrt-toolchain

      - name: Download target sysroot
        run: |
          TARGET_SYSROOT_URL=$(curl -s https://api.github.com/repos/piku235/mobilus-gtw-runtime/releases/latest | jq -r '.assets[] | select(.name=="target-sysroot.tar.gz") | .browser_download_url')
          wget -q "$TARGET_SYSROOT_URL"
          tar -xf target-sysroot.tar.gz

      - name: Export OpenWRT
        run: |
          TOOLCHAIN="toolchain-${ARCH}_gcc-${GCC_VERSION}_musl"
          echo "PATH=${PWD}/openwrt-toolchain/$TOOLCHAIN/bin:$PATH" >> $GITHUB_ENV
          echo "STAGING_DIR=${PWD}/openwrt-toolchain/$TOOLCHAIN" >> $GITHUB_ENV

      - name: Configure CMake
        run: cmake
          -B build
          -S ${{ github.workspace }}
          -DCMAKE_SYSROOT=${PWD}/target-sysroot
          -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/cmake/toolchains/mipsel.cmake
          -DCMAKE_BUILD_TYPE=Release

      - name: Build moblink
        run: cmake --build build

      - name: Strip moblink
        run: mipsel-openwrt-linux-strip build/moblink

      - name: Build package
        run: |
          mkdir -p target/.pkg
          mkdir -p target/bin
          mkdir -p target/etc/init.d
          cp -a build/moblink target/bin
          cp -a packaging/common/moblink.conf target/etc
          cp -a packaging/jpk/moblink.initd.template target/etc/init.d/moblink.template
          echo "${{ steps.strings.outputs.version }}" > target/.pkg/version
          cp -a packaging/jpk/postinst target/.pkg
          cp -a packaging/jpk/prerm target/.pkg
          tar --owner=0 --group=0 -czf moblink.jpk -C target .

      - name: Upload
        uses: softprops/action-gh-release@v2
        with:
          files: moblink.jpk
